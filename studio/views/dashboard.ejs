<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bona Studio | 묵상 제작소</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #b8860b;
            --bg-color: #111;
            --card-bg: #1a1a1a;
            --text-color: #eee;
            --muted-color: #888;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: var(--text-color);
            font-family: 'Noto Sans KR', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .glass-container {
            width: 100%;
            max-width: 1200px;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem;
            min-height: 90vh;
        }

        /* Header */
        .studio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            border-bottom: 1px solid rgba(184, 134, 11, 0.3);
            padding-bottom: 1rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--primary-color);
        }

        .brand h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
        }

        .brand i {
            font-size: 1.5rem;
        }

        nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Welcome Section */
        .welcome-section {
            margin-bottom: 3rem;
            text-align: center;
        }

        .welcome-section h2 {
            font-family: 'Cinzel', serif;
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .welcome-section p {
            color: #aaa;
            margin-bottom: 2rem;
        }

        .action-card {
            background: linear-gradient(135deg, rgba(184, 134, 11, 0.2), rgba(0, 0, 0, 0.4));
            border: 1px solid var(--primary-color);
            padding: 1.5rem;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .action-card:hover {
            transform: translateY(-3px);
        }

        .card-icon {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .card-text {
            text-align: left;
        }

        .card-text h3 {
            margin-bottom: 5px;
            color: #fff;
        }

        .card-text span {
            font-family: 'Cinzel';
            color: #ccc;
            font-size: 0.9rem;
        }

        .calendar-section {
            transition: opacity 0.3s ease;
            touch-action: pan-y pinch-zoom;
            /* 수평 스와이프 간섭 방지 */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-header h3 {
            font-family: 'Cinzel';
            color: #ddd;
            font-size: 1.5rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 15px;
            border-radius: 30px;
            border: 1px solid #333;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }

        .nav-btn:hover {
            color: #fff;
        }

        .month-selector {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
            min-width: 100px;
            text-align: center;
        }

        .today-btn {
            background: var(--primary-color);
            color: #000;
            border: none;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .day-name {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            padding: 10px;
            font-weight: bold;
            font-family: 'Cinzel';
        }

        .calendar-day {
            background: #222;
            border-radius: 12px;
            min-height: 120px;
            padding: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #333;
            background-size: cover;
            background-position: center;
        }

        .calendar-day:hover {
            border-color: #666;
            transform: scale(1.02);
            z-index: 10;
        }

        /* Today Style */
        .calendar-day.today {
            border: 2px solid var(--primary-color) !important;
            box-shadow: 0 0 15px rgba(184, 134, 11, 0.2);
        }

        /* Published Style */
        .calendar-day.has-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 11px;
        }

        .date-num {
            font-family: 'Cinzel';
            font-weight: bold;
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 2px #000;
        }

        .date-num.sunday {
            color: #ff6b6b;
        }

        .date-num.saturday {
            color: #48dbfb;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 2;
        }
    </style>

<body>
    <!-- Fallback Content (if CSS fails) -->
    <noscript>Please enable JavaScript</noscript>
    <div style="position:absolute; top:0; left:0; padding:5px; font-size:10px; opacity:0.3; pointer-events:none;">v1.0.1
    </div>

    <div class="glass-container">
        <header class="studio-header">
            <div class="brand">
                <i class="fa-solid fa-church"></i>
                <h1>Bona Studio</h1>
            </div>
            <nav>
                <div style="font-size: 0.9rem; margin-right: 1rem; color: #666; font-weight: bold;">
                    강종진 보나벤뚜라
                </div>
                <button class="btn-icon" onclick="openAdminModal()"><i class="fa-solid fa-gear"></i></button>
            </nav>
        </header>

        <main class="dashboard-main">
            <!-- (Existing Content) -->
            <section class="welcome-section">
                <h2>Peace be with you.</h2>
                <p>오늘도 주님의 말씀을 전할 준비가 되셨나요?</p>
                <div class="action-card" onclick="location.href='/studio/editor/<%= today %>'">
                    <div class="card-icon"><i class="fa-solid fa-feather-pointed"></i></div>
                    <div class="card-text">
                        <h3>오늘의 묵상 만들기</h3>
                        <span>
                            <%= today %>
                        </span>
                    </div>
                </div>
            </section>

            <section class="calendar-section">
                <!-- (Existing Calendar Header) -->
                <div class="calendar-header">
                    <h3>Publication Schedule</h3>
                    <div class="calendar-nav">
                        <button class="nav-btn"
                            onclick="location.href='/studio/?year=<%= prevYear %>&month=<%= prevMonth %>'">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <div class="month-selector">
                            <%= currentYear %>년 <%= currentMonth %>월
                        </div>
                        <button class="nav-btn"
                            onclick="location.href='/studio/?year=<%= nextYear %>&month=<%= nextMonth %>'">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                        <button class="today-btn" onclick="location.href='/studio'">
                            오늘
                        </button>
                    </div>
                </div>
                <!-- (Existing Calendar Grid) -->
                <div class="calendar-grid">
                    <div class="day-name">SUN</div>
                    <div class="day-name">MON</div>
                    <div class="day-name">TUE</div>
                    <div class="day-name">WED</div>
                    <div class="day-name">THU</div>
                    <div class="day-name">FRI</div>
                    <div class="day-name">SAT</div>

                    <% calendarDays.forEach(day=> { %>
                        <% if (day.isEmpty) { %>
                            <div class="calendar-day empty" style="visibility: hidden;"></div>
                            <% } else { %>
                                <% const isPublished=day.card && day.card.isPublished; const statusClass=(day.isToday
                                    ? 'today' : '' ) + (isPublished ? ' has-card' : '' ); const dayClass=day.isSunday
                                    ? 'sunday' : (day.isSaturday ? 'saturday' : '' ); const bgStyle=isPublished &&
                                    day.card.imageUrl ? `background-image: url('${day.card.imageUrl}');` : '' ; %>
                                    <div class="calendar-day <%= statusClass %>" style="<%= bgStyle %>"
                                        onclick="location.href='/studio/editor/<%= day.dateStr %>'">
                                        <span class="date-num <%= dayClass %>">
                                            <%= day.day %>
                                        </span>

                                        <% if (isPublished) { %>
                                            <span class="status-dot working" title="작성됨"
                                                style="background-color: #00b894;"></span>
                                            <% } else if (day.isToday) { %>
                                                <span class="status-dot" style="background-color: #ff4757;"></span>
                                                <% } %>
                                    </div>
                                    <% } %>
                                        <% }); %>
                </div>
            </section>
        </main>
    </div>

    <!-- Admin Modal -->
    <div id="adminModal" class="modal-overlay">
        <div class="modal-card">
            <button class="modal-close-btn" onclick="closeAdminModal()">✕</button>
            <h2 style="color: var(--primary-color); font-family: 'Cinzel'; margin-bottom: 2rem;">Studio Admin</h2>

            <div class="admin-menu">
                <button class="menu-item" onclick="loadSubscribers()">
                    <div class="icon-box"><i class="fa-solid fa-users"></i></div>
                    <div class="text-box">
                        <h3>구독자 현황</h3>
                        <p>현재 구독 중인 사용자 목록 확인</p>
                    </div>
                    <i class="fa-solid fa-chevron-right arrow"></i>
                </button>

                <button class="menu-item" onclick="triggerDeployment()">
                    <div class="icon-box"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                    <div class="text-box">
                        <h3>웹 서비스 동기화</h3>
                        <p>현재 소스를 웹 폴더로 즉시 배포</p>
                    </div>
                    <i class="fa-solid fa-chevron-right arrow"></i>
                </button>

                <!-- 추가 메뉴 확장 가능 -->
            </div>

            <div id="subListArea" style="display: none; margin-top: 1.5rem; text-align: left;">
                <h4 style="color: #ddd; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                    총 구독자: <span id="subCount" style="color: #00b894; font-size: 1.2rem;">0</span>명
                </h4>
                <div id="subListContent"
                    style="max-height: 200px; overflow-y: auto; background: #111; padding: 10px; border-radius: 8px; font-size: 0.85rem; color: #888; font-family: monospace;">
                    <!-- List items will go here -->
                </div>
                <button onclick="document.getElementById('subListArea').style.display='none'"
                    style="margin-top: 10px; background: none; border: 1px solid #555; color: #aaa; padding: 5px 10px; border-radius: 5px; cursor: pointer; width: 100%;">
                    목록 닫기
                </button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-card {
            background: #1e1e1e;
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid #333;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-close-btn:hover {
            color: #fff;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            background: #2a2a2a;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .menu-item:hover {
            background: #333;
            transform: translateX(5px);
        }

        .icon-box {
            width: 40px;
            height: 40px;
            background: rgba(184, 134, 11, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .text-box {
            flex: 1;
            text-align: left;
        }

        .text-box h3 {
            color: #eee;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .text-box p {
            color: #666;
            font-size: 0.8rem;
        }

        .arrow {
            color: #444;
        }
    </style>

    <script>
        // 초기 데이터 (서버에서 주입)
        let currentYear = parseInt('<%= currentYear %>') || new Date().getFullYear();
        let currentMonth = parseInt('<%= currentMonth %>') || (new Date().getMonth() + 1);
        const realToday = '<%= today %>'; // "YYYY-MM-DD"
        const [todayYear, todayMonth] = realToday.split('-').map(num => parseInt(num));

        let prevYear = <%= prevYear %>, prevMonth = <%= prevMonth %>;
        let nextYear = <%= nextYear %>, nextMonth = <%= nextMonth %>;

        // [AJAX] 달력만 업데이트하는 함수
        async function updateCalendar(y, m) {
            const calendarSection = document.querySelector('.calendar-section');
            calendarSection.style.opacity = '0.5'; // 로딩 표시 대용

            try {
                const res = await fetch(`${window.location.pathname}?year=${y}&month=${m}&ajax=true`);
                const json = await res.json();

                if (json.success) {
                    const data = json.data;

                    // 1. 전역 변수 업데이트
                    currentYear = data.currentYear;
                    currentMonth = data.currentMonth;
                    prevYear = data.prevYear; prevMonth = data.prevMonth;
                    nextYear = data.nextYear; nextMonth = data.nextMonth;

                    // 2. 헤더(년/월 표시) 업데이트
                    document.querySelector('.month-selector').innerText = `${currentYear}년 ${currentMonth}월`;

                    // 3. 네비게이션 버튼 이벤트 업데이트 (필요 시 주소창 pushState도 추가 가능)
                    // 현재는 단순 버튼 대신 onclick 로직을 함수로 대체하는 것이 좋으나, 
                    // 가장 확실한 건 calendar-grid 내용물을 새로 그리는 것

                    const grid = document.querySelector('.calendar-grid');
                    // 헤더(SUN~SAT)는 유지하고 날짜만 다시 그림
                    const headerHTML = `
                        <div class="day-name">SUN</div>
                        <div class="day-name">MON</div>
                        <div class="day-name">TUE</div>
                        <div class="day-name">WED</div>
                        <div class="day-name">THU</div>
                        <div class="day-name">FRI</div>
                        <div class="day-name">SAT</div>
                    `;

                    const daysHTML = data.calendarDays.map(day => {
                        if (day.isEmpty) return '<div class="calendar-day empty" style="visibility: hidden;"></div>';

                        const isPublished = day.card && day.card.isPublished;
                        const statusClass = (day.isToday ? 'today' : '') + (isPublished ? ' has-card' : '');
                        const dayClass = day.isSunday ? 'sunday' : (day.isSaturday ? 'saturday' : '');
                        const bgStyle = isPublished && day.card.imageUrl ? `background-image: url('${day.card.imageUrl}');` : '';

                        return `
                            <div class="calendar-day ${statusClass}" style="${bgStyle}" onclick="location.href='/studio/editor/${day.dateStr}'">
                                <span class="date-num ${dayClass}">${day.day}</span>
                                ${isPublished ? '<span class="status-dot working" title="작성됨" style="background-color: #00b894;"></span>' :
                                (day.isToday ? '<span class="status-dot" style="background-color: #ff4757;"></span>' : '')}
                            </div>
                        `;
                    }).join('');

                    grid.innerHTML = headerHTML + daysHTML;

                    // 주소창 업데이트 (페이지 점프 방지하면서 URL만 변경)
                    window.history.pushState({}, '', `${window.location.pathname}?year=${currentYear}&month=${currentMonth}`);
                }
            } catch (e) {
                console.error('[AJAX] Update Failed:', e);
            } finally {
                calendarSection.style.opacity = '1';
            }
        }

        let touchstartX = 0;
        let touchendX = 0;

        function checkDirection() {
            const diffX = touchendX - touchstartX;
            const threshold = 70;

            if (Math.abs(diffX) > threshold) {
                if (touchendX > touchstartX) {
                    console.log('[Calendar] Swiped Right -> Prev Month');
                    updateCalendar(prevYear, prevMonth);
                } else {
                    console.log('[Calendar] Swiped Left -> Next Month');
                    updateCalendar(nextYear, nextMonth);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const calendar = document.querySelector('.calendar-section');
            if (calendar) {
                calendar.addEventListener('touchstart', e => {
                    touchstartX = e.changedTouches[0].screenX;
                }, { passive: true });

                calendar.addEventListener('touchend', e => {
                    touchendX = e.changedTouches[0].screenX;
                    checkDirection();
                }, { passive: true });
            }

            // 기존 버튼들도 AJAX로 작동하게 변경
            document.querySelectorAll('.nav-btn').forEach((btn, idx) => {
                btn.removeAttribute('onclick');
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (idx === 0) updateCalendar(prevYear, prevMonth);
                    else updateCalendar(nextYear, nextMonth);
                });
            });

            // 오늘 버튼도 AJAX로 작동하게 변경 (페이지 점프 방지)
            const todayBtn = document.querySelector('.today-btn');
            if (todayBtn) {
                todayBtn.removeAttribute('onclick');
                todayBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('[Calendar] Moving to Today:', todayYear, todayMonth);
                    updateCalendar(todayYear, todayMonth);
                });
            }
        });

        function openAdminModal() { document.getElementById('adminModal').classList.add('open'); }
        function closeAdminModal() { document.getElementById('adminModal').classList.remove('open'); document.getElementById('subListArea').style.display = 'none'; }

        async function loadSubscribers() {
            const listArea = document.getElementById('subListArea');
            const countSpan = document.getElementById('subCount');
            const contentDiv = document.getElementById('subListContent');
            listArea.style.display = 'block';
            contentDiv.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 로딩 중...';

            try {
                const res = await fetch('/studio/api/subscribers');
                const json = await res.json();
                if (json.success) {
                    countSpan.innerText = json.count;
                    if (json.count === 0) contentDiv.innerHTML = '구독자가 없습니다.';
                    else {
                        contentDiv.innerHTML = json.list.map((sub, i) => `
                            <div style="padding: 5px 0; border-bottom: 1px solid #333;">
                                <span style="color: #b8860b;">#${i + 1}</span> 
                                <span title="${sub.endpoint}">${sub.endpoint.substring(0, 30)}...</span>
                            </div>
                        `).join('');
                    }
                } else { contentDiv.innerText = 'Error: ' + json.error; }
            } catch (e) { contentDiv.innerText = '통신 오류'; }
        }

        async function triggerDeployment() {
            if (!confirm('현재의 모든 카드와 리소스를 웹 폴더(/var/www/bona)로 즉시 배포하시겠습니까?\n기존 웹 폴더의 내용은 초기화됩니다.')) return;

            const btn = document.querySelector('button[onclick="triggerDeployment()"]');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.innerHTML = '<div class="icon-box"><i class="fa-solid fa-spinner fa-spin"></i></div><div class="text-box"><h3>배포 중...</h3><p>잠시만 기다려 주세요</p></div>';

            try {
                const res = await fetch('/studio/api/deploy', { method: 'POST' });
                const json = await res.json();
                if (json.success) {
                    alert('배포가 성공적으로 완료되었습니다.');
                } else {
                    alert('배포 도중 오류가 발생했습니다: ' + json.error);
                }
            } catch (e) {
                alert('서버 통신 오류가 발생했습니다.');
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = originalHTML;
            }
        }
    </script>
</body>

</html>