# Good Morning Bona 프로젝트 아키텍처 및 보안 규정 (V0.3)

## 1. 폴더 역할 정의

### 1.1 핵심 개발 및 엔진 폴더 (`/home/ucon/bona`)
- **유일성 원칙**: 굿모닝보나 프로젝트의 모든 중요 파일과 데이터가 들어있는 **유일한 핵심 폴더**.
- **격리 원칙**: 이 폴더 밖(타 시스템 경로 등)에 프로젝트 개발 관련 데이터나 파일이 존재해서는 안 됨.
- **배포 원본(Master Source)**: 루트 경로에는 `/var/www/bona` 웹폴더 배포를 위한 **원본 리소스**가 상시 준비되어 있어야 함.
- **자동 배포 규정**: **매일 06시**, 개발 폴더의 리소스를 기반으로 `/var/www/bona`를 전체 업데이트(동기화)하는 엔진 역할을 수행함.

### 1.2 관리자 전용 페이지 (`/home/ucon/bona/studio`)
- **역할**: 최고관리자(사용자) 전용 **AI 생성 및 발송 관리 시스템**.
- **접근 경로**: `uconai.ddns.net/studio`를 통해 접속됨.
- **특징**: 일반 구독자는 접근할 수 없는 독립적인 개발/관리 인터페이스 영역.

### 1.3 웹서비스 영역 (`/var/www/bona`)
- **역할**: 오로지 **구독자(Reader)를 위한 웹 서비스 창구**.
- **배포 규정**: 
    - `/home/ucon/bona`에 의해 매일 06시 자동으로 초기화 및 복사 배포됨.
    - 언제든지 삭제해도 개발 영역에는 영향이 없으며, 다시 복사하면 즉시 서비스되는 종속적인 구조임.
- **보안**: 중요 데이터나 개발용 로직 파일이 절대로 존재해서는 안 되는 순수 서비스용 보안 폴더.

## 2. 백엔드 아키텍처 및 관리 프로세스

### 2.1 프로세스 및 데이터 흐름 도표
| 구분 | 내용 | 상세 설명 |
| :--- | :--- | :--- |
| **포트 관리** | `3042` | Bona Studio 및 Reader 백엔드 전용 포트 (Node.js) |
| **DB 및 파일** | `JSON / File` | `subs.json`(구독자), `draft_YYYY-MM-DD.json`(묵상), `short_links.json` |
| **AI 생성** | `Gemini / DALL-E` | 6행시(Gemini) 및 고품질 이미지 생성 로직 엔진 |
| **자동 배포** | `Daily 06:00` | 매일 06시 카드 발행 및 `/var/www/bona` 동기화 (Node 내부 Scheduler) |
| **정적 리소스** | `/studio/public` | 이미지(`uploads/cards`), 서비스워커(`sw.js`), JS 등 핵심 자산 관리 |

### 2.2 핵심 구성 요소 격리 구조
- **사용자(Admin)**: `/studio` (PM2 ID: 6) 프로세스를 통한 AI 데이터 생성 및 발송 관리.
- **구독자(Reader)**: `/bona` 및 `/var/www/bona`를 통한 정적 페이지 열람 및 푸시 수신.
- **백데이터**: 모든 원본 이미지 및 JSON 데이터는 `/home/ucon/bona/data`에서 엄격히 격리 관리.

---

## 3. 네트워크 및 서버 인프라 정보

### 3.1 리눅스 서버 및 접속 환경
| 항목 | 정보 | 비고 |
| :--- | :--- | :--- |
| **도메인** | `uconai.ddns.net` | 외부 접속용 메인 호스트 주소 |
| **로컬 IP** | `192.168.0.150` | 내부망 서버 접근 IP |
| **서버 엔진** | `Caddy` | Reverse Proxy 및 자동 HTTPS 관리 |
| **프로세스 관리**| `PM2` | `bona-studio` 등 핵심 프로세스 무중단 운영 |
| **랜딩 페이지** | `/var/www/landing` | 통합 입구 (projects.json 연동) |

### 3.2 Caddy 라우팅 규칙
- **Landing**: `/` -> `/var/www/landing` (Static)
- **Studio**: `/bona/studio/*` -> `127.0.0.1:3042` (Reverse Proxy)
- **Reader API**: `/bona/api/*` -> `127.0.0.1:3042` (Reverse Proxy)
- **Reader UI**: `/bona/*` (Fallback) -> `/var/www/bona` (Static File Server)

---

---

## 4. 구조 정상화 및 보안 강화 로드맵 (4단계 마일스톤)

| 단계 | 구분 | 세부 과업 | 상태 | 목표 |
| :---: | :--- | :--- | :---: | :--- |
| **Step 1** | **데이터 통합** | 1.1 구독자 DB(`subs.json`) 정밀 병합 및 최신화 | 100% | `/var/www` 삭제 전 |
| | | 1.2 과거 묵상(`JSON`) 및 이미지 전수 수집/이동 | 100% | 모든 유효 데이터를 |
| | | 1.3 `sw.js`, 리더용 `JS`를 `studio/public`으로 이전 | 100% | `/home/ucon`으로 수렴 |
| **Step 2** | **엔진 독립** | 2.1 `app.js` 내 외부 폴더(`/var/www`) 참조 코드 제거 | 100% | 프로세스 보안 격리 |
| | | 2.2 노드 내부 `public` 경로로 모든 정적 자산 리매핑 | 100% | 및 외부 폴더와의 |
| | | 2.3 데이터 읽기/쓰기 경로를 `home/ucon`으로 고정 | 100% | 의존성 완전 차단 |
| **Step 3** | **배포 시스템** | 3.1 파일 동기화(`Home` -> `WWW`) 배포 함수 개발 | 100% | 매일 06시 배포 및 |
| | | 3.2 06:00 스케줄러에 자동 배포(Sync) 로직 탑재 | 100% | 관리자 페이지 내 |
| | | 3.3 관리자 전용 [배포 동기화] 수동 버튼 구현 | 100% | 원터치 배포 구현 |
| **Step 4** | **최종 대청소** | 4.1 `/var/www/bona` 내 중복 스튜디오 폴더 삭제 | 100% | 웹 폴더에서 모든 |
| | | 4.2 `/var/www/bona/data` 등 보안 위배 파일 제거 | 0% | 소스/데이터 찌꺼기 제거 |
| | | 4.3 전체 삭제 후 자동 재배포 무결성 테스트 | 100% | 및 구조화 완료 |
| **Step 5** | **정적 배포 완성** | 5.1 정적 템플릿(Baked Template) 설계 및 제작 | 0% | 데이터 주입형 단일 파일 |
| | | 5.2 배포 엔진 고도화(Data Baking & 날짜 파일 생성) | 0% | YYYY-MM-DD.html 자동생성 |
| | | 5.3 화살기도 데이터 체인(URL Parameter) 로직 탑재 | 0% | 엔진 없는 데이터 상속 |
| | | 5.4 엔진 완전 격리 및 SSR 소스 파기(Caddy/Express) | 0% | 외부 직결 통로 완전 봉쇄 |
| | | 5.5 무결성 실전 검증 (과거/현재 카드 열람 테스트) | 0% | 독립적 서비스 구조 확정 |

---

## 5. 배포 및 운영 원칙
(이하 동일)
